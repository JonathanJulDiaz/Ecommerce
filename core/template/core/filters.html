<div class="flex items-center justify-start px-2 z-20">
  <button id="filter-button"
    class="relative z-30 peer px-1 py-1 rounded-md bg-gray-500 hover:bg-gray-600 focus:bg-gray-600 active:bg-gray-700 transition">
    <span class="text-white flex items-center justify-between *:mx-1">
      <p class="text-lg">Filtros</p>
      <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
        <path fill="#FFFFFF"
          d="M3.9 54.9C10.5 40.9 24.5 32 40 32H472c15.5 0 29.5 8.9 36.1 22.9s4.6 30.5-5.2 42.5L320 320.9V448c0 12.1-6.8 23.2-17.7 28.6s-23.8 4.3-33.5-3l-64-48c-8.1-6-12.8-15.5-12.8-25.6V320.9L9 97.3C-.7 85.4-2.8 68.8 3.9 54.9z" />
      </svg>
    </span>
  </button>

  <div id="filter-menu"
    class="hidden z-30 fixed top-0 -left-96 lg:left-0 h-screen w-9/12 lg:w-72 bg-white shadow-2xl peer-focus:left-0 transition ease-out delay-150 duration-500">
    <nav role="navigation" class="p-6">
      <div class="relative mt-5">
        <h2 class="text-xl font-bold">Filtros</h2>
      </div>

      <div class="mt-2 -mx-4 relative overflow-y-scroll overflow-x-hidden h-[85vh]">
        <ul class="*:pr-2">

          <!--Por universidades-->
          <li>
            <div class="flex items-center justify-between px-3 text-gray-700 font-bold mb-2">
              <input id="input-universidad" class="mr-2" type="checkbox" onclick="checkAll(this, 'universidad')">
              <label for="input-universidad" class="text-lg leading-5 text-black">
                Por universidades
              </label>

              <button onclick="showMenu1(true, 'drop1', 'filter1')"
                class="focus:outline-none flex items-center py-2 px-2 bg-gray-300 hover:bg-gray-500 rounded-md delay-50 duration-500">
                <svg id="drop1" class="transform" width="12" height="12" xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 512 512">
                  <path
                    d="M233.4 406.6c12.5 12.5 32.8 12.5 45.3 0l192-192c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L256 338.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l192 192z" />
                </svg>
              </button>
            </div>

            <fieldset id="filter1" class="mb-1 *:mb-2 *:mx-6">
              {% for uni in universities %}
              <div class="flex items-center">
                <input id="university-{{ forloop.counter0 }}" type="checkbox" value="{{ uni.0 }}"
                  data-filter="universidad" data-key="{{ uni.1 }}"
                  class="filter-checkbox border-gray-300 hover:bg-gray-500">
                <label for="university-{{ forloop.counter0 }}" class="text-sm text-gray-900 ml-2 block">
                  {{ uni.1 }}
                </label>
              </div>
              {% endfor %}
            </fieldset>
          </li>

          <!--Por domicilio-->
          <li>
            <div class="flex items-center justify-between px-3 text-gray-700 font-bold mb-2">
              <div>
                <input id="input-domicilio" class="mr-2" type="checkbox" onclick="checkAll(this, 'domicilio')">
                <label class="text-lg leading-5 text-black" for="input-domicilio">
                  Por domicilio
                </label>
              </div>

              <button onclick="showMenu1(true, 'drop2', 'filter2')"
                class="focus:outline-none flex items-center py-2 px-2 bg-gray-300 hover:bg-gray-500 rounded-md delay-50 duration-500">
                <svg id="drop2" class="transform" width="12" height="12" xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 512 512">
                  <path
                    d="M233.4 406.6c12.5 12.5 32.8 12.5 45.3 0l192-192c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L256 338.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l192 192z" />
                </svg>
              </button>
            </div>

            <fieldset id="filter2" class="mb-1 *:mb-2 *:mx-6">
              {% for dom in domicilio %}
              <div class="flex items-center">
                <input id="domicilio-{{forloop.counter0}}" type="checkbox" value="{{ dom.0 }}" data-filter="domicilio"
                  data-key="{{ dom.1 }}" class="filter-checkbox border-gray-300 hover:bg-gray-500">
                <label for="domicilio-{{forloop.counter0}}" class="text-sm text-gray-900 ml-2 block">
                  {{ dom.1 }}
                </label>
              </div>
              {% endfor %}
            </fieldset>
          </li>

          <!--Por inventario-->
          <li>
            <div class="flex items-center justify-between px-3 text-gray-700 font-bold mb-2">
              <div>
                <input id="input-inventario" class="mr-2" type="checkbox" onclick="checkAll(this, 'inventario')">
                <label class="text-lg leading-5 text-black" for="input-inventario">
                  Por inventario
                </label>
              </div>

              <button onclick="showMenu1(true, 'drop3', 'filter3')"
                class="focus:outline-none flex items-center py-2 px-2 bg-gray-300 hover:bg-gray-500 rounded-md delay-50 duration-500">
                <svg id="drop3" class="transform" width="12" height="12" xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 512 512">
                  <path
                    d="M233.4 406.6c12.5 12.5 32.8 12.5 45.3 0l192-192c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L256 338.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l192 192z" />
                </svg>
              </button>
            </div>

            <fieldset id="filter3" class="mb-1 *:mb-2 *:mx-6">
              {% for inv in inventario %}
              <div class="flex items-center">
                <input id="inventario-{{forloop.counter0}}" type="checkbox" value="{{ inv.0 }}" data-filter="inventario"
                  data-key="{{ inv.1 }}" class="filter-checkbox border-gray-300 hover:bg-gray-500">
                <label for="inventario-{{forloop.counter0}}" class="text-sm text-gray-900 ml-2 block">
                  {{ inv.1 }}
                </label>
              </div>
              {% endfor %}
            </fieldset>
          </li>

          <!--Por precio-->
          <li>
            <div class="flex items-center justify-between px-3 text-gray-700 font-bold mb-2">
              <input id="input-precio" class="filter-checkbox mr-2" type="checkbox" data-filter="precio">
              <label class="text-lg leading-5 text-black" for="input-precio">
                Por precio
              </label>
              <button onclick="showMenu1(true, 'drop4', 'filter4')"
                class="focus:outline-none flex items-center py-2 px-2 bg-gray-300 hover:bg-gray-500 rounded-md delay-50 duration-500">
                <svg id="drop4" class="transform" width="12" height="12" xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 512 512">
                  <path
                    d="M233.4 406.6c12.5 12.5 32.8 12.5 45.3 0l192-192c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L256 338.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l192 192z" />
                </svg>
              </button>
            </div>

            <style>
              input[type=range]::-webkit-slider-thumb {
                pointer-events: all;
                width: 12px;
                height: 12px;
                -webkit-appearance: none;
                /* @apply w-6 h-6 appearance-none pointer-events-auto; */
              }
            </style>
            <div id="filter4">
              <div class="flex justify-center items-center mx-6">
                <div id="slider" x-data="range()" x-init="mintrigger(); maxtrigger()" class="relative max-w-xl w-full">
                  <div>
                    <input id="fromInput" type="range" step="5000" x-bind:min="min" x-bind:max="max"
                      x-on:input="mintrigger" x-model="minprice"
                      class="absolute pointer-events-none appearance-none z-20 h-2 w-full opacity-0 cursor-pointer">
  
                    <input id="toInput" type="range" step="5000" x-bind:min="min" x-bind:max="max" x-on:input="maxtrigger"
                      x-model="maxprice"
                      class="absolute pointer-events-none appearance-none z-20 h-2 w-full opacity-0 cursor-pointer">
  
                    <div class="relative z-10 h-2">
  
                      <div class="absolute z-10 left-0 right-0 bottom-0 top-0 rounded-md bg-gray-400"></div>
  
                      <div class="absolute z-20 top-0 bottom-0 rounded-md bg-gray-600"
                        x-bind:style="'right:'+maxthumb+'%; left:'+minthumb+'%'"></div>
  
                      <div class="absolute z-30 w-4 h-4 top-0 left-0 bg-gray-600 rounded-full -mt-1 -ml-1"
                        x-bind:style="'left: '+minthumb+'%'"></div>
  
                      <div class="absolute z-30 w-4 h-4 top-0 right-0 bg-gray-600 rounded-full -mt-1 -mr-1"
                        x-bind:style="'right: '+maxthumb+'%'"></div>
  
                    </div>
  
                  </div>
  
                  <div class="flex justify-between items-center mt-2 mb-3">
                    <div>
                      <input id="precio_min" type="text" maxlength="12" x-on:input="mintrigger" x-model="minprice"
                        class="mx-2 border border-gray-200 rounded w-24 text-center text-xs">
                    </div>
                    <div>
                      <input id="precio_max" type="text" maxlength="12" x-on:input="maxtrigger" x-model="maxprice"
                        class="mx-2 border border-gray-200 rounded w-24 text-center text-xs">
                    </div>
                  </div>

                  <div class="flex items-center">
                    <input id="precio-1" type="checkbox" value="0" data-filter="precio1"
                      data-key="5000" class="filter-checkbox border-gray-300 hover:bg-gray-500">
                    <label for="precio-1" class="text-sm text-gray-900 ml-2 block">
                      $ 0 - $ 5,000
                    </label>
                  </div>

                  <div class="flex items-center">
                    <input id="precio-2" type="checkbox" value="10000" data-filter="precio2"
                      data-key="30000" class="filter-checkbox border-gray-300 hover:bg-gray-500">
                    <label for="precio-2" class="text-sm text-gray-900 ml-2 block">
                      $ 10,000 - $ 30,000
                    </label>
                  </div>

                  <div class="flex items-center">
                    <input id="precio-3" type="checkbox" value="50000" data-filter="precio3"
                      data-key="100000" class="filter-checkbox border-gray-300 hover:bg-gray-500">
                    <label for="precio-3" class="text-sm text-gray-900 ml-2 block">
                      $ 50,000 - $ 100,000
                    </label>
                  </div>

                  <div class="flex items-center">
                    <input id="precio-4" type="checkbox" value="200000" data-filter="precio4"
                      data-key="500000" class="filter-checkbox border-gray-300 hover:bg-gray-500">
                    <label for="precio-4" class="text-sm text-gray-900 ml-2 block">
                      $ 200,000 - $500,000
                    </label>
                  </div>
  
                </div>
              </div>
            </div>
          </li>
        </ul>

        <div class="flex justify-between items-center mb-5 mx-2 my-3">
          <button onclick="reset()"
            class="rounded-lg px-2 py-2 bg-gray-700 text-white hover:bg-gray-800 delay-100 duration-500">
            Reiniciar filtros
          </button>

          <button id="filtros" type="submit"
            class="rounded-lg px-2 py-2 bg-green-500 hover:bg-green-600 delay-100 duration-500">
            Filtrar
          </button>
        </div>
      </div>
    </nav>
  </div>
</div>

<!--Boton de menu de filtros-->
<script>
  const menuBoton = document.getElementById('filter-button');
  const menu = document.getElementById('filter-menu');
  let menuAbierto = true; // Set to true to open the dropdown by default, false to close it by default

  // Function to toggle the dropdown
  function abrirMenu() {
    menuAbierto = !menuAbierto;
    if (menuAbierto) {
      menu.classList.remove('hidden');
    } else {
      menu.classList.add('hidden');
    }
  }

  // Initialize the dropdown state
  abrirMenu();

  // Toggle the dropdown when the button is clicked
  menuBoton.addEventListener('click', abrirMenu);

  // Close the dropdown when clicking outside of it
  window.addEventListener('click', (event) => {
    if (!menuBoton.contains(event.target) && !menu.contains(event.target)) {
      menu.classList.add('hidden');
      menuBoton.classList.remove('hidden');
      menuAbierto = false;
    }
  });
</script>

<!--Checkbox de cada filtro-->
<script>
  const showMenu1 = (rotar, icon, menu) => {
    let icono = document.getElementById(icon);
    let filtro = document.getElementById(menu);
    if (rotar) {
      icono.classList.toggle("rotate-180");
      filtro.classList.toggle("hidden");
    }
  };

  function checkAll(parent, filter) {
    var children = document.querySelectorAll("input[data-filter=" + filter + "]");
    children.forEach((child) => {
      if (child !== parent) child.checked = parent.checked;
    })
  }

  function reset() {
    var boxes = document.querySelectorAll("input[type='checkbox']");
    for (var i = 0; i < boxes.length; i++) {
      boxes[i].checked = false;
    }
  }
</script>

<!--Rango de precios-->
<script>
  function getRangePrice() {
    let slider = document.getElementById('slider');

  }
  function getPrice() {
    let values = [];

    $('.price').each(function () {
      let text = $(this).text().replace(/,/g, '');
      values.push(parseInt(text, 10));
    });

    let limit = [Math.min(...values), Math.max(...values)];
    return limit;
  }

  function range() {
    let range = getPrice();
    //$('#fromInput').attr("step", Math.round((range[1])/10));
    //$('#toInput').attr("step", Math.round((range[1])/10));
    return {
      minprice: range[0],
      maxprice: range[1],
      min: range[0] - 1000,
      max: range[1] + 1000,
      minthumb: 0,
      maxthumb: 0,

      mintrigger() {
        this.minprice = Math.min(this.minprice, this.maxprice - 500);
        this.minthumb = ((this.minprice - this.min) / (this.max - this.min)) * 100;
      },

      maxtrigger() {
        this.maxprice = Math.max(this.maxprice, this.minprice + 500);
        this.maxthumb = 100 - (((this.maxprice - this.min) / (this.max - this.min)) * 100);
      },
    }
  }
</script>

<!--Script para filtrar-->
<script>
  $(document).ready(function () {

    // Handle form submission
    $('#filtros').click(function (event) {
      event.preventDefault(); // Prevent form submission

      let universidad = [];
      let domicilio = [];
      let inventario = [];
      let price = [];

      $(".filter-checkbox:checked").each(function () {
        let filter_key = $(this).data("filter"); // universidad, domicilio, ...

        let value = $(this).val();
        if (filter_key == 'universidad') {
          universidad.push(value);
        }
        else if (filter_key == 'domicilio') {
          domicilio.push(value);
        }
        else if (filter_key == 'inventario') {
          inventario.push(value);
        }
        else if (filter_key == 'precio') {
          let min = parseInt($('#fromInput').val());
          let max = parseInt($('#toInput').val());

          price.push(min);
          price.push(max);
        }
        else{
          let min = parseInt(value);
          let max = parseInt($(this).data("key"));

          price.push(min);
          price.push(max);
        }
      });

      let category = $("#category").data("filter");
      let subcategory = $("#subcategory").data("filter");
      let tag = $("#tag").data("filter");

      $.ajax({
        type: "GET",
        url: "{% url 'filter-product' %}",
        data: {
          'universidad': universidad,
          'domicilio': domicilio,
          'inventario': inventario,
          'category': category,
          'subcategory': subcategory,
          'tag': tag,
          'price': price
        },
        dataType: 'json',
        beforeSend: function () {
          console.log(price);
        },
        success: function (response) {
          $("#filtered-products").html(response.data);
        },
      });
    });
  });
</script>